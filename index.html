<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes of the Jungle King</title>
    <style>
        :root {
            --bg-color: #0f140f;
            --text-color: #cbbf95;
            --accent-green: #2e4a2e;
            --highlight: #6b8c42;
            --danger: #8a3324;
            --panel-bg: #1a221a;
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #game-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            width: 100%;
            max-width: 1400px;
            height: 100vh;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
        }

        /* Sidebar: Stats & NPCs */
        #sidebar-left {
            background-color: var(--panel-bg);
            padding: 20px;
            border-right: 1px solid var(--accent-green);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .stat-box {
            border: 1px solid var(--accent-green);
            padding: 10px;
        }

        .stat-label {
            font-weight: bold;
            color: var(--highlight);
            display: block;
            margin-bottom: 5px;
        }

        .bar-container {
            background: #000;
            height: 10px;
            width: 100%;
            border: 1px solid #333;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s;
        }

        /* Main Content */
        #main-stage {
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            background: radial-gradient(circle at center, #141a14 0%, #0a0e0a 100%);
        }

        #narrative-display {
            font-size: 1.1rem;
            line-height: 1.6;
            height: 60%;
            overflow-y: auto;
            margin-bottom: 20px;
            white-space: pre-wrap;
            border-bottom: 1px solid var(--accent-green);
            padding-bottom: 20px;
        }

        .choice-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            background-color: var(--accent-green);
            color: var(--text-color);
            border: 1px solid var(--highlight);
            padding: 15px;
            font-family: var(--font-main);
            font-size: 1rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        button:hover {
            background-color: var(--highlight);
            color: #000;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Chat / System Log */
        #sidebar-right {
            background-color: var(--panel-bg);
            border-left: 1px solid var(--accent-green);
            display: flex;
            flex-direction: column;
        }

        #chat-history {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .chat-msg {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .chat-msg.system { color: #888; font-style: italic; }
        .chat-msg.player { color: var(--highlight); }
        .chat-msg.gm { color: #cd5c5c; }

        #chat-input-area {
            padding: 10px;
            border-top: 1px solid var(--accent-green);
            display: flex;
        }

        #chat-input {
            flex-grow: 1;
            background: #000;
            border: 1px solid var(--accent-green);
            color: var(--text-color);
            padding: 8px;
            font-family: var(--font-main);
        }

        /* Overlay */
        #overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .overlay-content {
            max-width: 600px;
            text-align: center;
        }

        .title {
            font-size: 3rem;
            color: var(--highlight);
            text-shadow: 0 0 10px var(--accent-green);
            margin-bottom: 20px;
        }

        .character-select-btn {
            display: block;
            width: 100%;
            margin: 10px 0;
            text-align: center;
        }

        .hidden { display: none !important; }

        /* Utility Classes */
        .text-danger { color: var(--danger); }
        .text-highlight { color: var(--highlight); }

    </style>
</head>
<body>

    <!-- Start / Character Creation Overlay -->
    <div id="overlay">
        <div id="start-screen" class="overlay-content">
            <h1 class="title">ECHOES OF THE<br>JUNGLE KING</h1>
            <p>An Interactive Survival Horror RPG</p>
            <br>
            <button onclick="showCharCreation()">Start Expedition</button>
            <button onclick="triggerGeneration()" style="margin-top:20px; border-color: #555; background:#222;">[DEV] Generate New Adventure (Webhook)</button>
        </div>

        <div id="char-creation" class="overlay-content hidden">
            <h2 id="cc-step-title">Step 1: Background</h2>
            <div id="cc-options"></div>
        </div>
    </div>

    <div id="game-container">
        <!-- LEFT: Stats -->
        <div id="sidebar-left">
            <div class="stat-box">
                <span class="stat-label">HEALTH (HP)</span>
                <div class="bar-container"><div id="hp-bar" class="bar-fill" style="width: 100%; background: #8a3324;"></div></div>
                <span id="hp-val">100/100</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">SANITY (SP)</span>
                <div class="bar-container"><div id="sp-bar" class="bar-fill" style="width: 100%; background: #4682b4;"></div></div>
                <span id="sp-val">100/100</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">SUPPLIES</span>
                <span id="supplies-val" style="font-size: 1.5rem;">50</span>
            </div>
            
            <hr style="border-color:#333; width:100%;">

            <div class="stat-box">
                <span class="stat-label">ATTRIBUTES</span>
                <div>MIGHT: <span id="stat-str">0</span></div>
                <div>WITS: <span id="stat-int">0</span></div>
                <div>GRIT: <span id="stat-wil">0</span></div>
                <div>LUCK: <span id="stat-lck">0</span></div>
            </div>

            <div class="stat-box">
                <span class="stat-label">COMPANIONS</span>
                <div>Kaelo: <span id="rel-kaelo">5</span>/10</div>
                <div>Dr. Thorne: <span id="rel-thorne">5</span>/10</div>
            </div>
        </div>

        <!-- CENTER: Narrative -->
        <div id="main-stage">
            <div id="narrative-display"></div>
            <div id="choices-area" class="choice-container"></div>
        </div>

        <!-- RIGHT: Chat -->
        <div id="sidebar-right">
            <div style="padding:10px; border-bottom:1px solid #333;">EXPEDITION LOG</div>
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Enter notes or discuss..." onkeypress="handleChat(event)">
            </div>
        </div>
    </div>

    <script>
        // --- GAME CONFIGURATION & STATE ---
        const webhookUrl = 'https://n8n.srv931177.hstgr.cloud/webhook-test/gamemaster';
        
        const gameState = {
            hp: 100,
            maxHp: 100,
            sp: 100,
            maxSp: 100,
            supplies: 50,
            stats: { str: 10, int: 10, wil: 10, lck: 10 }, 
            npcs: {
                kaelo: { name: "Kaelo", rel: 5, status: "Alive" },
                thorne: { name: "Dr. Thorne", rel: 5, status: "Alive" }
            },
            modifiers: {
                str: 0, int: 0, wil: 0, lck: 0
            },
            diffMod: 0, 
            act: 1,
            scene: 'start'
        };

        // --- WEBHOOK TRIGGER ---
        async function startGameGeneration(theme) {
            try {
                addLog("System", "Contacting Game Master server...");
                await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme: theme })
                });
                alert('Generation started! Reload in a minute.');
                addLog("GM", "World generation signal sent. The jungle shifts...");
            } catch (e) {
                alert('Connection failed (Dev Mode Only).');
                addLog("System", "Error connecting to server.");
            }
        }

        function triggerGeneration() {
            startGameGeneration("Lovecraftian Jungle Horror");
        }

        // --- CHARACTER CREATION MODULE ---
        let ccStep = 0;

        function showCharCreation() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('char-creation').classList.remove('hidden');
            renderCCStep();
        }

        const ccData = [
            {
                title: "Select Background",
                options: [
                    { label: "The Mercenary (High Might, Low Wits)", effect: () => { setStats(2, -1, 1, 0); } },
                    { label: "The Professor (High Wits, Low Might)", effect: () => { setStats(-1, 2, 0, 1); } },
                    { label: "The Survivor (High Grit, Balanced)", effect: () => { setStats(0, 0, 2, 0); } }
                ]
            },
            {
                title: "Select Personality",
                options: [
                    { label: "Aggressive (+1 Might)", effect: () => { gameState.modifiers.str++; } },
                    { label: "Calculating (+1 Wits)", effect: () => { gameState.modifiers.int++; } },
                    { label: "Superstitious (+1 Luck)", effect: () => { gameState.modifiers.lck++; } }
                ]
            },
            {
                title: "Select Goal",
                options: [
                    { label: "Slay the King", effect: () => {} },
                    { label: "Steal the Heart", effect: () => {} },
                    { label: "Document the Truth", effect: () => {} }
                ]
            }
        ];

        function setStats(s, i, w, l) {
            gameState.modifiers.str = s;
            gameState.modifiers.int = i;
            gameState.modifiers.wil = w;
            gameState.modifiers.lck = l;
        }

        function renderCCStep() {
            const container = document.getElementById('cc-options');
            const title = document.getElementById('cc-step-title');
            container.innerHTML = '';
            
            if (ccStep >= ccData.length) {
                startGame();
                return;
            }

            title.innerText = ccData[ccStep].title;
            ccData[ccStep].options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'character-select-btn';
                btn.innerText = opt.label;
                btn.onclick = () => {
                    opt.effect();
                    ccStep++;
                    renderCCStep();
                };
                container.appendChild(btn);
            });
        }

        // --- GAME ENGINE ---

        function startGame() {
            document.getElementById('overlay').classList.add('hidden');
            updateHUD();
            addLog("System", "Expedition started.");
            loadScene("intro");
        }

        function updateHUD() {
            // Stats
            document.getElementById('stat-str').innerText = formatMod(gameState.modifiers.str);
            document.getElementById('stat-int').innerText = formatMod(gameState.modifiers.int);
            document.getElementById('stat-wil').innerText = formatMod(gameState.modifiers.wil);
            document.getElementById('stat-lck').innerText = formatMod(gameState.modifiers.lck);

            // Resources
            const hpPct = Math.max(0, (gameState.hp / gameState.maxHp) * 100);
            const spPct = Math.max(0, (gameState.sp / gameState.maxSp) * 100);
            
            document.getElementById('hp-bar').style.width = hpPct + "%";
            document.getElementById('hp-val').innerText = `${Math.max(0, gameState.hp)}/${gameState.maxHp}`;
            
            document.getElementById('sp-bar').style.width = spPct + "%";
            document.getElementById('sp-val').innerText = `${Math.max(0, gameState.sp)}/${gameState.maxSp}`;
            
            document.getElementById('supplies-val').innerText = gameState.supplies;

            // NPCs
            document.getElementById('rel-kaelo').innerText = gameState.npcs.kaelo.rel;
            document.getElementById('rel-thorne').innerText = gameState.npcs.thorne.rel;

            // FX
            if (gameState.hp < 30) document.body.style.boxShadow = "inset 0 0 100px #500";
            else document.body.style.boxShadow = "none";
        }

        function formatMod(val) {
            return val >= 0 ? `+${val}` : val;
        }

        // Scene Database
        const sceneDB = {
            "intro": {
                text: "ACT I: THE GREEN GATE\n\nThe humidity hits you like a physical wall. The canopy above is so thick that midday looks like twilight. Ahead lies the Serpent River.\n\nKaelo checks his machete. 'The King is watching,' he mutters.\nDr. Thorne scoffs, wiping his glasses. 'Superstitious nonsense. We are here for science.'",
                choices: [
                    { text: "Push forward towards the ravine.", action: "loadScene('bridge')" }
                ]
            },
            "bridge": {
                text: "SCENE: THE ROTTING BRIDGE\n\nA deep ravine cuts through the jungle path. A vine bridge spans the gap, swaying ominously in the wind. It smells of wet rot.\n\nKaelo refuses to cross first. Thorne looks at you expectantly.",
                choices: [
                    { text: "[MIGHT] Reinforce the bridge with rope and strength (DC 12).", type: "check", stat: "str", dc: 12, success: "bridge_str_s", fail: "bridge_str_f" },
                    { text: "[WITS] Analyze the counter-weight mechanism (DC 14).", type: "check", stat: "int", dc: 14, success: "bridge_int_s", fail: "bridge_int_f" },
                    { text: "[LUCK] Sprint across before it snaps (DC 10 - RISKY).", type: "check", stat: "lck", dc: 10, success: "bridge_lck_s", fail: "bridge_lck_f" }
                ]
            },
            // Bridge Outcomes (Point to nightwatch)
            "bridge_str_s": { text: "With a grunt of exertion, you lash the fraying vines. The bridge holds firm. Kaelo nods in respect.", effects: { kaelo: 1 }, next: "nightwatch" },
            "bridge_str_f": { text: "You pull the vines tight, but wrench your back in the process. The bridge holds, barely.", effects: { hp: -5 }, next: "nightwatch" },
            "bridge_int_s": { text: "You spot a hidden lever under the moss. The bridge stabilizes instantly. Thorne looks impressed despite himself.", effects: { int: 1 }, next: "nightwatch" },
            "bridge_int_f": { text: "You pull the wrong vine. A trap triggers, sending your backpack tumbling into the ravine.", effects: { supplies: -10 }, next: "nightwatch" },
            "bridge_lck_s": { text: "You run. Boards crack under your feet, but you dive to the other side just as a plank falls away. Adrenaline surges.", effects: { lck: 1 }, next: "nightwatch" },
            "bridge_lck_f": { text: "CRACK. The bridge gives way. You fall, slamming into the cliff side before catching a root. You climb up, battered and shaken.", effects: { hp: -5, sp: -5 }, next: "nightwatch" },

            "nightwatch": {
                text: "ACT II: THE WHISPERING RUINS\n\nNight falls. You set camp near ancient stone ruins. Something stalks the perimeter. Two glowing eyes float in the darkness.\nThorne raises his revolver. 'I'll shoot it!'",
                choices: [
                    { text: "[GRIT] Stare down the darkness. Do not flinch (DC 15).", type: "check", stat: "wil", dc: 15, success: "night_wil_s", fail: "night_wil_f" },
                    { text: "[WITS] Throw food to distract it (Cost: 15 Supplies).", type: "direct", next: "night_feed" },
                    { text: "[MIGHT] Fire blindly into the bush (DC 12 - RISKY).", type: "check", stat: "lck", dc: 12, success: "night_agg_s", fail: "night_agg_f" }
                ]
            },
            // Night Outcomes
            "night_wil_s": { text: "You stare into the abyss. The eyes blink and retreat. You feel mentally fortified.", effects: { sp: 2 }, next: "end_demo" },
            "night_wil_f": { text: "The eyes... they aren't eyes. They are floating lights. The trees are laughing. You close your eyes and scream silently.", effects: { sp: -5 }, next: "end_demo" },
            "night_feed": { text: "You toss your rations. The beast eats and leaves. Thorne sneers at your wastefulness.", effects: { supplies: -15, thorne: -1 }, next: "end_demo" },
            "night_agg_s": { text: "BANG! A yelp. You found a jaguar. Meat for tonight.", effects: { supplies: 10 }, next: "end_demo" },
            "night_agg_f": { text: "BANG! Kaelo screams. You grazed his arm.", effects: { kaelo: -3 }, next: "end_demo" },

            "end_demo": {
                text: "ACT III: THE THRONE OF ROOTS\n\nYou have survived... for now. The demo ends here, but the Jungle King still waits.\n\nThank you for playing.",
                choices: [
                    { text: "Restart", action: "location.reload()" }
                ]
            },
            "game_over": {
                text: "DEATH\n\nThe Jungle claims another soul. Your bones will feed the roots.",
                choices: [ { text: "Try Again", action: "location.reload()" } ]
            },
            "game_over_madness": {
                text: "MADNESS\n\nYour mind shatters. You wander into the dark, laughing at jokes only the shadows whisper.",
                choices: [ { text: "Try Again", action: "location.reload()" } ]
            }
        };

        function loadScene(sceneId) {
            // Supply consumption check (excluding outcomes with underscores or start/intro)
            if (sceneId !== 'intro' && sceneId !== 'start' && !sceneId.includes('_')) {
                gameState.supplies -= 5;
                if(gameState.supplies < 0) {
                    gameState.hp -= 10;
                    addLog("System", "Starving! -10 HP");
                }
            }

            // Death Checks
            if (gameState.hp <= 0) { renderScene(sceneDB["game_over"]); return; }
            if (gameState.sp <= 0) { renderScene(sceneDB["game_over_madness"]); return; }

            const scene = sceneDB[sceneId];
            if (!scene) {
                console.error("Scene missing: " + sceneId);
                return;
            }
            renderScene(scene);
        }

        function renderScene(sceneData) {
            const narrativeDiv = document.getElementById('narrative-display');
            const choicesDiv = document.getElementById('choices-area');

            // Dynamic Text Injection (Madness/Injury)
            let displayText = sceneData.text;
            if (gameState.sp < 30) displayText += "\n\n(The walls seem to be breathing. You hear crawling sounds inside your own ears.)";
            if (gameState.hp < 30) displayText += "\n\n(Your vision blurs from pain. Blood drips steadily.)";

            narrativeDiv.innerText = displayText;
            narrativeDiv.scrollTop = 0;
            choicesDiv.innerHTML = '';

            // Handle immediate effects from transition scenes
            if (sceneData.effects) {
                applyEffects(sceneData.effects);
                updateHUD();
            }

            // Detect available choices or create implicit "Continue"
            let choices = sceneData.choices;
            if (!choices && sceneData.next) {
                choices = [{ text: "Continue...", type: "direct", next: sceneData.next }];
            }

            if (choices) {
                choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.innerText = choice.text;
                    
                    if (choice.action) {
                        btn.onclick = () => eval(choice.action);
                    } else if (choice.type === 'check') {
                        btn.onclick = () => handleRoll(choice);
                    } else if (choice.type === 'direct') {
                        btn.onclick = () => loadScene(choice.next);
                    }
                    
                    choicesDiv.appendChild(btn);
                });
            }
        }

        function handleRoll(choice) {
            const roll = Math.floor(Math.random() * 20) + 1;
            const mod = gameState.modifiers[choice.stat];
            const total = roll + mod;
            
            addLog("Dice", `Rolled ${roll} + ${mod} = ${total} (Target: ${choice.dc})`);

            if (total >= choice.dc) {
                loadScene(choice.success);
            } else {
                loadScene(choice.fail);
            }
        }

        function applyEffects(effects) {
            if(effects.hp) gameState.hp += effects.hp;
            if(effects.sp) gameState.sp += effects.sp;
            if(effects.supplies) gameState.supplies += effects.supplies;
            if(effects.str) gameState.modifiers.str += effects.str;
            if(effects.int) gameState.modifiers.int += effects.int;
            if(effects.lck) gameState.modifiers.lck += effects.lck;
            if(effects.kaelo) gameState.npcs.kaelo.rel += effects.kaelo;
            if(effects.thorne) gameState.npcs.thorne.rel += effects.thorne;
        }

        // --- CHAT SYSTEM ---

        function handleChat(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('chat-input');
                const text = input.value;
                if (!text) return;
                
                addLog("You", text);
                input.value = '';

                setTimeout(() => {
                    const responses = [
                        "Kaelo sharpens his blade silently.",
                        "Dr. Thorne scribbles in his journal, ignoring you.",
                        "Something howls in the distance.",
                        "The radio crackles with static."
                    ];
                    addLog("Game", responses[Math.floor(Math.random() * responses.length)]);
                }, 1000);
            }
        }

        function addLog(sender, msg) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            
            let cssClass = "system";
            if (sender === "You") cssClass = "player";
            if (sender === "GM" || sender === "Game") cssClass = "gm";

            div.className = `chat-msg ${cssClass}`;
            div.innerHTML = `<strong>${sender}:</strong> ${msg}`;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

    </script>
</body>
</html>